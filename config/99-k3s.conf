# K3s Kernel Parameters Configuration
# File: /etc/sysctl.d/99-k3s.conf
# Applied by: 03-configure-k3s.sh
# Purpose: Optimize kernel parameters for Kubernetes and security

# =============================================================================
# KUBERNETES NETWORKING REQUIREMENTS
# =============================================================================

# Enable bridge netfilter (required for Kubernetes networking)
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# Enable IP forwarding (required for pod networking and service routing)
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# =============================================================================
# SECURITY HARDENING
# =============================================================================

# Disable ICMP redirects (security hardening)
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Disable secure redirects (security hardening)
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Disable source routing (security hardening)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Enable source validation (reverse path filtering)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log suspicious packets
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Ignore ping broadcasts (security)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP responses (security)
net.ipv4.icmp_ignore_bogus_error_responses = 1

# =============================================================================
# TCP/UDP TUNING FOR CONTAINERS
# =============================================================================

# Increase TCP connection tracking table size
net.netfilter.nf_conntrack_max = 262144

# TCP keepalive settings for better connection management
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes = 3

# Enable TCP window scaling for better performance
net.ipv4.tcp_window_scaling = 1

# Enable selective acknowledgments
net.ipv4.tcp_sack = 1

# =============================================================================
# FILE SYSTEM AND PROCESS LIMITS
# =============================================================================

# Increase inotify limits for container file watching
fs.inotify.max_user_watches = 1048576
fs.inotify.max_user_instances = 8192

# Increase file descriptor limits
fs.file-max = 2097152

# Increase process limits
kernel.pid_max = 4194304

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Improve memory management for containers
vm.max_map_count = 262144

# Set swappiness to prefer RAM over swap (important for K8s)
vm.swappiness = 1

# Enable memory overcommit (careful - monitor usage)
vm.overcommit_memory = 1

# =============================================================================
# ARP TABLE OPTIMIZATION
# =============================================================================

# Increase ARP table sizes for pod networking
net.ipv4.neigh.default.gc_thresh1 = 4096
net.ipv4.neigh.default.gc_thresh2 = 6144
net.ipv4.neigh.default.gc_thresh3 = 8192

# =============================================================================
# SECURITY: KERNEL HARDENING
# =============================================================================

# Disable core dumps for security
kernel.core_pattern = |/bin/false

# Restrict kernel pointer access
kernel.kptr_restrict = 2

# Disable kernel address exposure
kernel.dmesg_restrict = 1

# Restrict access to kernel logs
kernel.printk = 3 3 3 3

# =============================================================================
# CONTAINER-SPECIFIC OPTIMIZATIONS
# =============================================================================

# Increase default socket buffer sizes
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# Optimize network device queue length
net.core.netdev_max_backlog = 5000

# Increase connection tracking timeout for UDP
net.netfilter.nf_conntrack_udp_timeout = 30
net.netfilter.nf_conntrack_udp_timeout_stream = 180

# =============================================================================
# NOTES:
# =============================================================================
# 
# These settings are optimized for:
# - K3s/Kubernetes networking requirements
# - Container workload performance  
# - Security hardening
# - Multi-pod networking
#
# Monitor system performance after applying these settings.
# Adjust values based on your specific workload requirements.
# 
# To verify applied settings:
# sudo sysctl -a | grep -E "(bridge|forward|redirect)"
#
# To apply immediately:
# sudo sysctl -p /etc/sysctl.d/99-k3s.conf