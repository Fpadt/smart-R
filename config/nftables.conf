#!/usr/sbin/nft -f

# Clear any existing rules
flush ruleset

# Create a new table for filtering traffic
table inet filter {
    # Input chain: handles incoming traffic
    chain input {
        type filter hook input priority filter;
        policy drop;

        # Allow traffic from established connections
        ct state established,related accept

        # Allow localhost traffic
        iif lo accept

        # ✅ KUBERNETES CLUSTER TRAFFIC - ADD THESE BEFORE OTHER RULES
        # Allow traffic from pod network to anywhere (including API server)
        ip saddr 10.42.0.0/16 accept
        
        # Allow traffic to service network from anywhere
        ip daddr 10.43.0.0/16 accept
        
        # Allow established cluster traffic
        ip saddr { 10.42.0.0/16, 10.43.0.0/16 } ct state established,related accept

        # Allow SSH ONLY from your IP and rate limit it
        ip saddr ${HOME_IP} tcp dport ${SSH_PORT} ct state new limit rate 15/minute burst 5 packets accept
        ip saddr ${HOME_IP} tcp dport ${SSH_PORT} ct state established,related accept

        # Allow HTTP/HTTPS (ports 80, 443) for Traefik
        tcp dport { 80, 443 } accept

        # ✅ Allow Kubernetes API access
        tcp dport 6443 accept

        # ✅ Allow Kubelet port
        tcp dport 10250 accept

        # ✅ Allow VXLAN traffic (Flannel overlay)
        udp dport 8472 accept

        # ICMP (Ping) rate-limited
        icmp type echo-request limit rate 5/second accept

        # Log and drop everything else
        log prefix "nftables DROP: " flags all counter
        drop
    }

    chain forward {
        type filter hook forward priority filter;
        policy drop;
        
        # ✅ Allow Kubernetes cluster forwarding
        ip saddr 10.42.0.0/16 ip daddr 10.42.0.0/16 accept
        ip saddr 10.42.0.0/16 ip daddr 10.43.0.0/16 accept
        ct state established,related accept
    }

    # Output chain: handles outgoing traffic
    chain output {
        type filter hook output priority filter;
        policy accept;
    }
}